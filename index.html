<!DOCTYPE html>
<html lang="fr">
<head>
<meta charset="UTF-8" />
<meta name="viewport" content="width=device-width, initial-scale=1" />
<title>Visualisation Hydra + Micro</title>

<style>
  body, html {
    margin: 0; padding: 0; overflow: hidden; background: #000;
    height: 100%;
    font-family: Arial, sans-serif;
  }
  #startOverlay {
    position: fixed;
    top:0; left:0; right:0; bottom:0;
    background: rgba(30,30,30,0.7);
    display: flex;
    justify-content: center;
    align-items: center;
    z-index: 10;
    cursor: pointer;
  }
  #startBtn {
    background: rgba(180,180,180,0.3);
    border: 2px solid rgba(180,180,180,0.6);
    color: #ddd;
    font-size: 2.5rem;
    padding: 1.2rem 3rem;
    border-radius: 12px;
    user-select: none;
    transition: background 0.3s ease;
  }
  #startBtn:hover {
    background: rgba(180,180,180,0.5);
  }
  canvas {
    display: block;
    width: 100vw !important;
    height: 100vh !important;
  }
</style>

<script src="https://cdn.jsdelivr.net/npm/p5@1.6.0/lib/p5.min.js"></script>
<script src="https://cdn.jsdelivr.net/npm/p5@1.6.0/lib/addons/p5.sound.min.js"></script>
<script src="https://cdn.jsdelivr.net/npm/hydra-synth/dist/hydra-synth.js"></script>

</head>
<body>

<div id="startOverlay">
  <div id="startBtn">Démarrer le micro</div>
</div>

<script>
let hydra, mic, fft;
let isStarted = false;

const overlay = document.getElementById('startOverlay');
const startBtn = document.getElementById('startBtn');

startBtn.addEventListener('click', () => {
  if (isStarted) return;

  mic = new p5.AudioIn();

  mic.start(() => {
    // Micro activé, on peut lancer hydra et fft
    overlay.style.display = 'none';
    isStarted = true;

    fft = new p5.FFT();
    fft.setInput(mic);

    // Init Hydra
    hydra = new Hydra({
      canvas: document.createElement('canvas'),
      detectAudio: false,
      enableStreamCapture: false,
    });
    document.body.appendChild(hydra.canvas);
    hydra.canvas.style.position = 'fixed';
    hydra.canvas.style.top = '0';
    hydra.canvas.style.left = '0';
    hydra.canvas.style.width = '100vw';
    hydra.canvas.style.height = '100vh';
    hydra.canvas.style.zIndex = '1';

    drawHydra();
  }, (err) => {
    alert("Erreur d'accès au micro : " + err.message);
  });
});

function drawHydra() {
  if (!isStarted) return;

  let bass = fft.getEnergy("bass") / 255;
  let mid = fft.getEnergy("mid") / 255;
  let treble = fft.getEnergy("treble") / 255;

  // Si signal faible, on diminue progressivement l'intensité
  let volume = mic.getLevel();
  let fade = volume > 0.01 ? 1 : Math.max(0, fade - 0.02);
  if (fade === undefined) fade = 1;

  osc(10, 0.03, 0.8)
    .color(
      0.3 + bass * 1.5,
      0.4 + mid * 1.2,
      0.5 + treble * 1.3
    )
    .rotate(() => performance.now() * 0.00002 + mid * 0.15)
    .modulate(
      osc(5, 0.02)
        .rotate(() => performance.now() * 0.0001 + treble * 0.5),
      0.3
    )
    .kaleid(6)
    .scale(() => 1 + mid * 0.4)
    .blend(o0, 0.25)
    .mult(fade)
    .out();

  requestAnimationFrame(drawHydra);
}
</script>

</body>
</html>
